<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Management - Alerts</title>
    <style>
        /* --- Base and Resets --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        html, body {
            height: 100%; /* Ensure body takes full height */
            margin: 0;
            overflow: hidden; /* Prevent body scrollbar */
        }

        /* --- Main Layout --- */
        .dashboard {
            display: flex;
            height: 100vh; /* Use viewport height */
            overflow: hidden; /* Prevent dashboard overflow */
        }

        .sidebar {
            width: 250px; /* Fixed width */
            flex-shrink: 0; /* Prevent sidebar from shrinking */
            background: #1e40af;
            color: white;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow sidebar scrolling if menu is long */
        }

        .sidebar a {
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .logo {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
        }

        .menu-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .menu-item:hover {
            background: #1e3a8a;
        }

        .menu-item.active {
            background: #1e3a8a;
            border-left: 4px solid white;
            padding-left: calc(1.5rem - 4px);
        }

        .main-content {
            flex: 1; /* Take remaining space */
            background: #f0f5ff;
            padding: 2rem;
            display: flex; /* Enable flex column layout */
            flex-direction: column;
            overflow: hidden; /* Prevent main content itself from scrolling */
        }

        /* --- Header & User Info --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; /* Reduced margin */
            flex-shrink: 0; /* Prevent header from shrinking */
        }
        .header h1 {
            font-size: 1.8rem; /* Slightly smaller */
        }

        .user-info {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }

        .user-avatar {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: #1e40af;
            color: white;
            text-align: center;
            line-height: 40px;
            border-radius: 50%;
            font-weight: bold;
        }

        .user-name {
            font-weight: bold;
        }

        /* --- Logout Modal --- */
        .logout-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6); /* Darker overlay */
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .logout-modal-content {
            background: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            width: 90%; /* Responsive width */
            max-width: 320px; /* Max width */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .logout-modal-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .logout-btn { background-color: #1e40af; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; font-weight: bold; }
        .logout-btn:hover { background-color: #162d79; }
        .cancel-btn { background-color: #ccc; color: black; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; }
        .cancel-btn:hover { background-color: #bbb; }

        /* --- Filter Section --- */
        .filter-section {
            margin-bottom: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0; /* Prevent filter section from shrinking */
        }
        .filter-section label { font-size: 1rem; font-weight: bold; color: #333; }
        #priorityFilter {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 0.375rem;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
            min-width: 150px;
        }
        #priorityFilter:hover { border-color: #1e40af; }
        #priorityFilter:focus { outline: none; border-color: #1e40af; box-shadow: 0 0 5px rgba(30, 64, 175, 0.5); }

        /* --- Alerts Container (SCROLLABLE AREA) --- */
        .alerts-container {
            flex: 1; /* Allow container to grow and fill remaining space */
            overflow-y: auto; /* THIS MAKES THE CONTAINER SCROLLABLE */
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem; /* Reduced gap */
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 10px;
            background-color: #f9f9f9;
            padding-bottom: 1rem; /* Add padding at the bottom */
        }
        /* Scrollbar Styling (Optional) */
        .alerts-container::-webkit-scrollbar { width: 8px; }
        .alerts-container::-webkit-scrollbar-thumb { background: #bdbdbd; border-radius: 10px; }
        .alerts-container::-webkit-scrollbar-track { background: #f1f1f1; }

        /* --- Alert Card Styling --- */
        .alert-card {
            background: white;
            padding: 1.2rem; /* Slightly reduced padding */
            border-radius: 8px; /* Slightly less rounded */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            border-left: 5px solid; /* Slightly thicker border */
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
        }
        .alert-card.hidden { opacity: 0; transform: translateY(-15px); display: none; }
        /* Priority Borders */
        .alert-card.high { border-left-color: #ef4444; }
        .alert-card.medium { border-left-color: #f59e0b; }
        .alert-card.software { border-left-color: #8b5cf6; }
        .alert-card.request { border-left-color: #3b82f6; }
        .alert-card.low { border-left-color: #10b981; }
        /* Priority Type Badges */
        .alert-type { font-size: 0.8rem; padding: 0.25rem 0.6rem; border-radius: 9999px; font-weight: 500; }
        .alert-type.high { background: #fee2e2; color: #b91c1c; } /* Darker red text */
        .alert-type.medium { background: #fef3c7; color: #b45309; }/* Darker orange text */
        .alert-type.software { background: #ede9fe; color: #6d28d9; }/* Darker purple text */
        .alert-type.request { background: #dbeafe; color: #1d4ed8; }/* Darker blue text */
        .alert-type.low { background: #d1fae5; color: #047857; }/* Darker green text */
        /* Alert Header */
        .alert-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.8rem; }
        .alert-header h3 { display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; }
        /* Alert Content */
        .alert-content { margin-top: 0.8rem; line-height: 1.5; color: #4b5563; }
        .alert-content p { margin-bottom: 0.4rem; }
        .alert-content strong { color: #1f2937; font-weight: 600;}
        /* Alert Actions */
        .alert-actions { margin-top: 1rem; display: flex; gap: 0.8rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 5px; border: none; cursor: pointer; font-weight: 500; font-size: 0.9rem; transition: background-color 0.2s ease; }
        .btn-primary { background: #1e40af; color: white; text-decoration: none;}
        .btn-primary:hover { background: #1e3a8a; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }

        /* --- New Alert Indicator --- */
        .alert-card.new-alert { background-color: #fefce8; border-left-width: 7px; }
        .new-badge {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
            background-color: #dc2626;
            border-radius: 0.25rem;
            vertical-align: middle;
            line-height: 1;
        }
        .alert-card.return_request { border-left-color: #8b5cf6; }
.alert-type.return_request { background: #f3e8ff; color: #7c3aed; }
        /* --- No Alerts Message --- */
        .no-alerts-message {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
            font-size: 1.1rem;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            background-color: #f9fafb;
            margin: 1rem; /* Add margin so it doesn't touch borders */
        }

        /* --- Responsiveness --- */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem; /* Reduced padding on smaller screens */
            }
            .header h1 {
                font-size: 1.5rem; /* Smaller heading */
            }
            .filter-section {
                padding: 0.8rem;
                gap: 0.8rem;
            }
            .alert-card {
                padding: 1rem;
            }
             /* Optional: Hide sidebar on very small screens - requires JS toggle */
            /*
            .sidebar {
                 display: none;
            }
            */
        }
        .alert-badge {
    display: inline-block;
    margin-left: 8px;
    padding: 0.2rem 0.5rem;
    background-color: #ef4444; /* Red background */
    color: white; /* White text */
    font-size: 0.75rem;
    font-weight: bold;
    border-radius: 9999px; /* Fully rounded corners */
    line-height: 1;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.btn-highlight {
    background-color: #facc15; /* amber-400 */
    color: #1f2937; /* gray-800 */
}

    </style>
</head>
<body>

    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo" style="display: flex; align-items: center; gap: 0.5rem;">
                <img src="/media/assets/images/logo.svg" alt="Logo" style="width: 24px; height: 24px;">
                <span>Asset Manager</span>
              </div>
            <a href="{% url 'dashboard' %}" class="menu-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                <div>Dashboard</div>
            </a>
            <a href="{% url 'Asset Inventory' %}" class="menu-item {% if request.resolver_match.url_name == 'Asset Inventory' %}active{% endif %}">
                <div>Asset Inventory</div>
            </a>
             <a href="{% url 'Add Asset' %}" class="menu-item {% if request.resolver_match.url_name == 'add_asset_selection' or request.resolver_match.url_name == 'add_hardware_asset' or request.resolver_match.url_name == 'add_software_asset' %}active{% endif %}">
                <div>Add Asset</div>
            </a>
            <a href="{% url 'Alerts' %}" class="menu-item {% if request.resolver_match.url_name == 'Alerts' %}active{% endif %}">
                <div>
                    Alerts
                    <!-- New Alert Badge -->
                    {% if total_new_alerts > 0 %}
                        <span class="alert-badge">{{ total_new_alerts }}</span>
                    {% endif %}
                </div>
            </a>
            <a href="{% url 'MaintenancePage' %}" class="menu-item {% if request.resolver_match.url_name == 'MaintenancePage' %}active{% endif %}">
                <div>Maintenance</div>
            </a>
            <a href="{% url 'asset_request_tracking' %}" class="menu-item {% if request.resolver_match.url_name == 'asset_request_tracking' %}active{% endif %}">
                <div>Asset Requests</div>
            </a>
            <a href="{% url 'Reports' %}" class="menu-item {% if request.resolver_match.url_name == 'Reports' %}active{% endif %}">
                <div>Reports</div>
            </a>
            <a href="{% url 'user_management' %}" class="menu-item ">
                <div>Users</div>
            </a>
            
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header Section -->
            <div class="header">
                <h1>Alerts & Notifications</h1>
                 <!-- Display User Info and Logout Trigger -->
                <div class="user-info" onclick="openLogoutModal()">
                    <span class="user-name">{{ user.username }}</span>
                    <div class="user-avatar">
                        {{ user.username.0|upper }}{{ user.username.1|upper }}
                    </div>
                </div>
            </div>

            <!-- Logout Pop-up Modal -->
            <div id="logoutModal" class="logout-modal">
                <div class="logout-modal-content">
                    <p>Are you sure you want to logout?</p>
                    <div class="logout-modal-buttons">
                        <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
                        <button type="button" onclick="closeLogoutModal()" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section">
                <button class="btn btn-highlight" onclick="showNewAlerts()">Show New Alerts</button>

                <label for="priorityFilter">Filter by Type:</label>
                <select id="priorityFilter" onchange="filterAlerts()">
                    <option value="all">Show All</option>
                    <option value="high">Maintenance Due</option>
                    <option value="medium">Bond Expiry</option>
                    <option value="software">Software Renewals</option>
                    <option value="request">Pending Requests</option>
                    <option value="low">Warranty Expiry</option>
                    <option value="return_request">Return Requests</option>
                </select>
                 <!-- Optional: Add sorting dropdown here if needed -->
            </div>

            <!-- Alerts Container (This part will scroll) -->
            <div class="alerts-container">
                {% if alerts %}
                    {% for alert in alerts %}
                        {# Add the 'new-alert' class if is_new is true #}
                        <div class="alert-card {{ alert.type }} {% if alert.is_new %}new-alert{% endif %}"
                             id="alert-{{ alert.id }}"
                             data-priority="{{ alert.type }}"
                             data-alert-id="{{ alert.id }}"
                             {% if alert.sort_date %}data-date="{{ alert.sort_date|date:"Y-m-d" }}"{% endif %}>

                            <div class="alert-header">
                                <h3>
                                    {# Alert Title #}
                                    {% if alert.type == 'high' %} Maintenance Due Soon
                                    {% elif alert.type == 'medium' %} Usage Bond Expiring
                                    {% elif alert.type == 'software' %} Software License Renewal Due
                                    {% elif alert.type == 'low' %} Warranty Expiring Soon
                                    {% elif alert.type == 'request' %} New Asset Request Received
                                    {% else %} General Alert {% endif %}

                                    {# "New" Badge - appears next to the title if alert.is_new is true #}
                                    {% if alert.is_new %}
                                        <span class="new-badge">New</span>
                                    {% endif %}
                                </h3>
                                <span class="alert-type {{ alert.type }}">
                                    {# Alert Priority/Type Description #}
                                    {% if alert.type == 'high' %} High Priority
                                    {% elif alert.type == 'medium' %} Medium Priority
                                    {% elif alert.type == 'software' %} Renewal Due
                                    {% elif alert.type == 'low' %} Low Priority
                                    {% elif alert.type == 'request' %} Pending Action
                                    {% else %} Info {% endif %}
                                </span>
                            </div>

                            <div class="alert-content">
                                {% if alert.type == 'high' %}
                                    {# Maintenance Data #}
                                    <p><strong>Asset:</strong> {{ alert.data.AssetName }} ({{ alert.data.AssetNumber|default:'N/A' }})</p>
                                    <p><strong>Due Date:</strong> {{ alert.data.next_maintenance_date_calculated|date:"F d, Y" }}</p>
                                    {% if alert.data.VendorID %}<p><strong>Vendor:</strong> {{ alert.data.VendorID.VendorName }}</p>{% endif %}
                                    <p><strong>Days Left:</strong> {{ alert.days_left }} day{{ alert.days_left|pluralize }}</p>
                                {% elif alert.type == 'medium' %}
                                    {# Bond Expiry Data #}
                                    <p><strong>Asset:</strong> {{ alert.data.AssetName }} ({{ alert.data.AssetNumber|default:'N/A' }})</p>
                                    <p><strong>Expiry Date:</strong> {{ alert.data.BondExpiryDate|date:"F d, Y" }}</p>
                                    {% if alert.data.VendorID %}<p><strong>Vendor:</strong> {{ alert.data.VendorID.VendorName }}</p>{% endif %}
                                    <p><strong>Days Left:</strong> {{ alert.days_left }} day{{ alert.days_left|pluralize }}</p>
                                {% elif alert.type == 'software' %}
                                     {# Software Renewal Data #}
                                    <p><strong>Software:</strong> {{ alert.data.AssetName }} ({{ alert.data.AssetNumber|default:'N/A' }})</p>
                                    <p><strong>Renewal Date:</strong> {{ alert.data.RenewDate|date:"F d, Y" }}</p> {# Assumes RenewDate field exists #}
                                    {% if alert.data.VendorID %}<p><strong>Vendor:</strong> {{ alert.data.VendorID.VendorName }}</p>{% endif %}
                                    <p><strong>Days Left:</strong> {{ alert.days_left }} day{{ alert.days_left|pluralize }}</p>
                                {% elif alert.type == 'low' %}
                                     {# Warranty Expiry Data #}
                                    <p><strong>Asset:</strong> {{ alert.data.AssetName }} ({{ alert.data.AssetNumber|default:'N/A' }})</p>
                                    <p><strong>Warranty Expiry:</strong> {{ alert.data.warranty_expiry_date_calculated|date:"F d, Y" }}</p>
                                    {% if alert.data.VendorID %}<p><strong>Vendor:</strong> {{ alert.data.VendorID.VendorName }}</p>{% endif %}
                                    <p><strong>Days Left:</strong> {{ alert.days_left }} day{{ alert.days_left|pluralize }}</p>
                                {% elif alert.type == 'request' %}
                                     {# Asset Request Data #}
                                    <p><strong>Requester:</strong> {{ alert.data.UserId.username }}</p>
                                    <p><strong>Asset:</strong> {{ alert.data.AssetID.AssetName }} ({{ alert.data.AssetID.AssetNumber|default:'N/A' }})</p>
                                    <p><strong>Dates:</strong> {{ alert.data.StartDate|date:"M d, Y" }} to {{ alert.data.EndDate|date:"M d, Y" }}</p>
                                    <p><strong>Purpose:</strong> {{ alert.data.Purpose|default:"N/A"|truncatechars:150 }}</p>
                                    <p><strong>Requested On:</strong> {{ alert.data.RequestedAt|date:"M d, Y, P" }}</p>
                                {% elif alert.type == 'return_request' %}
                                    <h3>Asset Return Requested</h3>
                                    <span class="alert-type return_request">Return Request</span>

                                    <p><strong>Requested By:</strong> {{ alert.data.StageBy.username }}</p>
                                    <p><strong>Asset:</strong> {{ alert.data.RequestId.AssetID.AssetName }} ({{ alert.data.RequestId.AssetID.AssetNumber|default:'N/A' }})</p>
                                    <p><strong>Date Requested:</strong> {{ alert.data.StageDate|date:"F d, Y, P" }}</p>
                                    <p><strong>User:</strong> {{ alert.data.RequestId.UserId.username }}</p>
                                {% endif %}
                            </div>

                            <div class="alert-actions">
                                {# Link to relevant pages based on alert type #}
                                {% if alert.type == 'request' %}
                                     {# Use request_id if available, otherwise pk #}
                                    <a href="{% url 'asset_request_tracking' %}?request_id={{ alert.data.RequestId|default:alert.data.pk }}" class="btn btn-primary">View Request</a>
                                {% elif alert.type == 'high' or alert.type == 'medium' or alert.type == 'low' or alert.type == 'software' %}
                                     {# Use AssetID if available, otherwise pk #}
                                     {# Ensure alert.data refers to the Asset object here #}
                                      <a href="{% url 'Asset Inventory' %}?asset_id={{ alert.data.AssetID|default:alert.data.pk }}" class="btn btn-primary">View Asset</a>
                                {% endif %}
                              
                            </div>

                        </div>
                    {% endfor %}
                {% else %}
                     {# Displayed when the alerts list passed from the view is empty #}
                     <div class="no-alerts-message">
                        <p>ðŸŽ‰ No current alerts or notifications. Everything looks good!</p>
                     </div>
                {% endif %}
                 {# This is where a dynamic "no matching filter" message could be added by JS #}
                 <div id="no-filter-match" style="display: none; text-align: center; padding: 2rem; color: #6b7280;">
                     No alerts match the selected filter.
                 </div>
            </div> <!-- End Alerts Container -->

        </div> <!-- End Main Content -->
    </div> <!-- End Dashboard -->

    <script>
        function showNewAlerts() {
    const alerts = document.querySelectorAll('.alert-card');
    const noFilterMatchMsg = document.getElementById('no-filter-match');
    const initialNoAlertsMsg = document.querySelector('.no-alerts-message');
    let hasVisible = false;

    alerts.forEach(alert => {
        if (alert.classList.contains('new-alert')) {
            alert.style.display = '';
            hasVisible = true;
        } else {
            alert.style.display = 'none';
        }
    });

    if (!hasVisible && !initialNoAlertsMsg) {
        if(noFilterMatchMsg) noFilterMatchMsg.style.display = 'block';
    } else {
        if(noFilterMatchMsg) noFilterMatchMsg.style.display = 'none';
    }
}

        document.addEventListener("DOMContentLoaded", function() {
            // Ensure the modal is hidden when the page loads
            const logoutModal = document.getElementById("logoutModal");
            if (logoutModal) {
                logoutModal.style.display = "none";
            }
             // Initial filter application on load
            filterAlerts();
        });

        // --- Logout Modal Logic ---
        function openLogoutModal() {
            const logoutModal = document.getElementById("logoutModal");
            if (logoutModal) {
                logoutModal.style.display = "flex"; // Show modal using flex
            }
        }

        function closeLogoutModal() {
            const logoutModal = document.getElementById("logoutModal");
            if (logoutModal) {
                logoutModal.style.display = "none"; // Hide modal
            }
        }

        // Close logout modal if user clicks outside the modal box
        window.onclick = function(event) {
            const logoutModal = document.getElementById("logoutModal");
            // Check if the click happened on the modal background itself
            if (event.target === logoutModal) {
                closeLogoutModal(); // Close modal
            }
        }

        // --- Alert Filtering Logic ---
        function filterAlerts() {
            const selectedPriority = document.getElementById('priorityFilter').value;
            const alerts = document.querySelectorAll('.alert-card'); // Get all alert cards
            const noFilterMatchMsg = document.getElementById('no-filter-match');
            const initialNoAlertsMsg = document.querySelector('.no-alerts-message'); // The one from Django template
            let hasVisibleAlerts = false;

            alerts.forEach(alert => {
                const alertPriority = alert.getAttribute('data-priority');
                // Show if 'all' is selected OR if the alert's priority matches the filter
                if (selectedPriority === 'all' || alertPriority === selectedPriority) {
                    alert.style.display = ''; // Show the alert card
                    hasVisibleAlerts = true;
                } else {
                    alert.style.display = 'none'; // Hide the alert card
                }
            });

            // Show/Hide the "No matching filter" message
            // Only show this message if there *were* initial alerts to filter
            if (!hasVisibleAlerts && !initialNoAlertsMsg) {
                if(noFilterMatchMsg) noFilterMatchMsg.style.display = 'block';
            } else {
                if(noFilterMatchMsg) noFilterMatchMsg.style.display = 'none';
            }
        }

    </script>
</body>
</html>