<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Inventory - Reports</title>
    <script src="/static/chart.min.js"></script>
    <script src="/static/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
 
        .dashboard {
            display: flex;
            min-height: 100vh;
        }
 
        .sidebar {
            width: 250px;
            background: #1e40af;
            color: white;
            padding: 2rem 0;
        }
 
        .sidebar a {
            text-decoration: none;
            color: inherit;
            display: block;
        }
 
        .logo {
            padding: 0 1.5rem;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
 
        .menu-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
       
        .menu-item:hover {
            background: #1e3a8a;
        }
 
        .menu-item.active {
            background: #1e3a8a;
            border-left: 4px solid white;
        }
 
        .main-content {
            flex: 1;
            background: #f0f5ff;
            padding: 2rem;
        }
 
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .user-info {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px; /* Space between avatar and username */
        }

        .user-avatar {
            display: inline-block;
            width: 40px;
            height: 40px;
            background-color: #1e40af;
            color: white;
            text-align: center;
            line-height: 40px;
            border-radius: 50%;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .user-name {
            font-weight: bold;
            transition: transform 0.3s ease;
        }
        /* Logout Modal Background */
        .logout-modal {
            display: none; /* Modal should be hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5); /* Dark Overlay */
            z-index: 1000;
            display: flex; /* Flexbox layout to center the modal */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        /* Logout Modal Box */
        .logout-modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 300px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        /* Logout Modal Buttons */
        .logout-modal-buttons {
            margin-top: 15px;
        }

        .logout-btn {
            background-color: #1e40af;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            margin-right: 10px;
            display: inline-block;
        }

        .logout-btn:hover {
            background-color: #162d79;
        }

        .cancel-btn {
            background-color: #ccc;
            color: black;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .cancel-btn:hover {
            background-color: #bbb;
        }
        /* New styles for sections */
        .section {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
 
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
 
        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
 
        .section-controls {
            display: flex;
            gap: 1rem;
        }
 
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s;
        }
 
        .btn-primary {
            background: #1e40af;
            color: white;
        }
 
        .btn-secondary {
            background: #e2e8f0;
            color: #1e40af;
        }
 
        .btn:hover {
            opacity: 0.9;
        }
 
        .toggle-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #1e40af;
        }
 
        .section-content {
            transition: max-height 0.3s ease-out;
            overflow: hidden;
        }
 
        .section-content.hidden {
            max-height: 0;
        }


        #assetDataContent {
            max-height: 300px;
            overflow-y: auto;
        }

        #assetDataContent.hidden {
            max-height: 0;
            overflow: hidden;
        }


        /* Table styles */
        .idle-analysis-container {
                margin-top: 1rem;
            }
 
            .asset-table {
                width: 100%;
                border-collapse: collapse;
            }
 
            .asset-table thead {
                position: sticky;
                top: 0; /* Fix the header at the top */
                background-color: #fff; /* Ensure the header is visible */
                z-index: 1; /* Keep the header above the rows */
            }
 
            .asset-table th,
            .asset-table td {
                padding: 8px;
                text-align: left;
                border: 1px solid #ddd;
            }
       
            /* Charts Container */
            .charts-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* Adjusts based on screen size */
                gap: 1.5rem;
                margin-top: 1rem;
            }
 
            /* Chart Container */
            /* Chart Container */
            .charts-container {
                display: flex; /* Arrange charts side by side */
                gap: 1rem; /* Add spacing between charts */
                flex-wrap: wrap; /* Allow charts to stack on smaller screens */
            }
 
            /* Chart Box */
            .chart-box {
                width: 100%; /* Ensure each chart takes full width on small screens */
                max-width: 500px; /* Optional: Set a maximum width for larger screens */
                background: white;
                border-radius: 8px;
                padding: 1rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                position: relative; /* Required for canvas positioning */
            }
 
            /* Canvas Styling */
            .chart-box canvas {
                width: 100%; /* Ensure the canvas fills its container */
                height: auto; /* Allow height to adjust dynamically */
                position: absolute; /* Position the canvas within the container */
                top: 0;
                left: 0;
            }
 
 
            /* Chart Canvas */
            .chart {
                width: 100%; /* Ensures the chart scales with its container */
                height: auto;
            }
 
            .chart-container:hover {
                transform: translateY(-5px); /* Slight lift on hover */
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15); /* Enhanced shadow */
            }
 
            /* Cost Analysis Wrapper */
            .cost-analysis-wrapper {
                display: flex;
                gap: 20px;
                margin-top: 20px;
                align-items: stretch; /* Ensures children stretch to match heights */
            }
 
            
            .cost-box-content {
                text-align: center;
            }
 
            .cost-label {
                font-size: 1.1rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
            }
 
            .cost-value {
                font-size: 2rem;
                font-weight: bold;
            }
 
            /* Cost Table Wrapper */
            .cost-table-wrapper {
                flex: 1;
                overflow-x: auto; /* Enable horizontal scrolling if needed */
            }
 
            /* Cost Table Styles */
            #cost-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 14px;
                margin-top: 1rem;
            }
 
            #cost-table thead th {
                background-color: #f2f2f2;
                color: #333;
                padding: 15px;
                text-align: left;
                border: 1px solid #ddd;
                font-weight: bold;
            }
 
            #cost-table tbody td {
                padding: 15px;
                border: 1px solid #ddd;
                text-align: left;
            }
 
            #cost-table tbody tr:hover {
                background-color: #f9f9f9;
            }
 
            /* Ensure minimum height for the table when there's little data */
            #cost-table tbody tr:first-child td,
            #cost-table tbody tr:last-child td {
                padding: 20px;
            }
 
            /* Cost Summary Grid */
            .cost-summary-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
                margin-bottom: 2rem;
            }
 
            .cost-summary-box {
                padding: 1.5rem;
                border-radius: 8px;
                color: white;
                text-align: center;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
 
            .cost-summary-box.total {
                background-color: #1e40af;
            }
 
            .cost-summary-box.provider {
                background-color: #1e40af;
            }
 
            .cost-summary-box.classification {
                background-color: #1e40af;
            }
 
            .cost-label {
                font-size: 1rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
            }
 
            .cost-value {
                font-size: 1.5rem;
                font-weight: bold;
            }
 
            .cost-details {
                font-size: 1rem;
                margin-top: 0.5rem;
            }
 
           
            .charts-container {
                
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 2rem;
                margin-top: 2rem;
            }
 
            .chart-box {
                background: white;
                border-radius: 8px;
                padding: 1.5rem;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                height: 300px;
            }
 
            .chart-title {
                font-size: 1.1rem;
                font-weight: bold;
                margin-bottom: 1rem;
                color: #1e40af;
            }
 
            @media (max-width: 768px) {
                .charts-container {
                    grid-template-columns: 1fr;
                }
            }
            .custom-report-btn {
  background-color: #1e40af;
  color: white;
  padding: 10px 16px;
  border-radius: 4px;
  border: none;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transition: background-color 0.3s ease;
  text-decoration: none;
  display: inline-block;
  font-size: 14px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.custom-report-btn:hover {
  background-color: #15339a; /* Slightly darker shade for hover */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  cursor: pointer;
}

.custom-report-btn:active {
  background-color: #122c85; /* Even darker for active state */
  transform: translateY(1px);
}.alert-badge {
    display: inline-block;
    margin-left: 8px;
    padding: 0.2rem 0.5rem;
    background-color: #ef4444; /* Red background */
    color: white; /* White text */
    font-size: 0.75rem;
    font-weight: bold;
    border-radius: 9999px; /* Fully rounded corners */
    line-height: 1;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="sidebar">
            <div class="logo" style="display: flex; align-items: center; gap: 0.5rem;">
                <img src="/media/assets/images/logo.svg" alt="Logo" style="width: 24px; height: 24px;">
                <span>Asset Manager</span>
              </div>
            <a href="{% url 'dashboard' %}" class="menu-item">
                <div>Dashboard</div>
            </a>
            <a href="{% url 'Asset Inventory' %}" class="menu-item">
                <div>Asset Inventory</div>
            </a>
            <a href="{% url 'Add Asset' %}" class="menu-item">
                <div>Add Asset</div>
            </a>
            <a href="{% url 'Alerts' %}" class="menu-item {% if request.resolver_match.url_name == 'Alerts' %}active{% endif %}">
                <div>
                    Alerts
                    <!-- New Alert Badge -->
                    {% if total_new_alerts > 0 %}
                        <span class="alert-badge">{{ total_new_alerts }}</span>
                    {% endif %}
                </div>
            </a>
            <a href="{% url 'MaintenancePage' %}" class="menu-item ">
                <div>Maintenance</div>
            </a>
            <a href="{% url 'asset_request_tracking' %}" class="menu-item ">
                <div>Asset Requests</div>
            </a>
            <a href="{% url 'Reports' %}" class="menu-item active">
                <div>Reports</div>
            </a>
            <a href="{% url 'user_management' %}" class="menu-item ">
                <div>Users</div>
            </a>
        </div>
        <div class="main-content">

            <div class="header">

                <h1>Reports</h1>
                <a href="{% url 'custom_report_builder' %}" class="custom-report-btn">Customize Your Report</a>
                <div class="actions">

                  

                    <div class="user-info" onclick="openLogoutModal()">

                        <span class="user-name">{{ user.username }}</span>

                        <div class="user-avatar">

                            {{ user.email.0|upper }}{{ user.email.1|lower }}

                        </div>

                    </div>

                </div>

            </div>
            
            <!-- Logout Pop-up Modal -->
            <div id="logoutModal" class="logout-modal">
                <div class="logout-modal-content">
                    <p>Are you sure you want to logout?</p>
                    <div class="logout-modal-buttons">
                        <a href="{% url 'logout' %}" class="logout-btn">Logout</a>
                        <button onclick="closeLogoutModal()" class="cancel-btn">Cancel</button>
                    </div>
                </div>
            </div>
            <div class="section" style="background: #1e40af; color: white; padding: 1rem; margin-bottom: 2rem; border-radius: 8px;">
                <div class="section-header" style="margin-bottom: 0;">
                    <h2 class="section-title" style="color: white;">Download Complete Report</h2>
                    <div class="section-controls">
                        <button class="btn" style="background: white; color: #1e40af;" onclick="downloadCombinedReports()">
                            Download All Reports
                        </button>
                    </div>
                </div>
            </div>
 
            <!-- Asset Data Section -->
            <div class="section" id="assetDataSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>Asset Data</span>
                    </h2>
                    <div class="section-controls">
                        <button class="btn btn-primary" onclick="location.href='{% url 'download_asset_data_pdf' %}'">
                            Download Report
                        </button>
                        <button class="btn btn-secondary" onclick="toggleSection('assetDataSection')">
                            Toggle View
                        </button>
                    </div>
                </div>
                <div class="section-content" id="assetDataContent" >
                    <table class="asset-table">
                        <thead>
                            <tr>
                                <th>Asset ID</th>
                                <th>Asset Number</th>
                                <th>Serial Number</th>
                                <th>PartNumber</th>
                                <th>Asset Model</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in assets %}
                            <tr>
                                <td>{{ asset.AssetID }}</td>
                                <td>{{ asset.AssetNumber }}</td>
                                <td>{{ asset.SerialNumber }}</td>
                                <td>{{ asset.PartNumber }}</td>
                                <td>{{ asset.AssetModel }}</td>
                                <td>{{ asset.AssetName }}</td>
                                <td>{{ asset.Category }}</td>
                                <td>{{ asset.AssetStatus }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">No assets available.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
 
            <div class="section" id="costAnalysisSection">
                <div class="section-header">
                    <h2 class="section-title">Cost Analysis</h2>
                    <div class="section-controls">
                        <!-- Category Filter -->
                        <select id="cost-category-filter" class="form-control" style="width: 200px; margin-right: 1rem;">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-primary" onclick="downloadCostAnalysisReport()">
                            Download Report
                        </button>
                        <button class="btn btn-secondary" onclick="toggleSection('costAnalysisSection')">
                            Toggle View
                        </button>
                    </div>
                </div>
                <div class="section-content">
                    <!-- Overall Cost Summary -->
                    <div class="cost-summary-grid">
                        <div class="cost-summary-box total">
                            <div class="cost-box-content">
                                <div class="cost-label">Total Cost of Assets</div>
                                <br>
                                <div class="cost-details">
                                    <div><h2> ₹<span id="total-cost">{{ total_cost|floatformat:2 }}</span></h2></div>
                                </div>
                            </div>
                        </div>
                        <div class="cost-summary-box provider">
                            <div class="cost-box-content">
                                <div class="cost-label">Cost by Asset Provider</div>
                                <div class="cost-details">
                                    <div>CSI-Purchased: ₹<span id="csi-purchased-cost">0.00</span></div>
                                    <div>CSI-Borrowed: ₹<span id="csi-borrowed-cost">0.00</span></div>
                                    <div>Total CSI: ₹<span id="total-csi-cost">0.00</span></div>
                                    <div>BGSW: ₹<span id="bgsw-cost">0.00</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="cost-summary-box classification">
                            <div class="cost-box-content">
                                <div class="cost-label">Cost by Asset Classification</div>
                                <div class="cost-details">
                                    <div>Consumables: ₹<span id="consumables-cost">0.00</span></div>
                                    <div>Non Consumables: ₹<span id="non-consumables-cost">0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
           
                    <!-- Charts Grid -->
                    <div class="charts-container">
                        <div class="chart-box">
                            
                            <canvas id="providerChart"></canvas>
                            
                        </div>
                        <div class="chart-box">
                            
                            <canvas id="classificationChart"></canvas>
                            
                        </div>
                    </div>
           
                    <!-- Cost Breakdown Table -->
                    <div class="cost-table-wrapper" style="max-height: 300px; overflow-y: auto;">
                        <table id="cost-table">
                            <thead>
                                <tr>
                                    <th>Category</th>
                                    <th>Asset Provider</th>
                                    <th>Asset Classification</th>
                                    <th>Total Cost (₹)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in cost_breakdown %}
                                <tr>
                                    <td>{{ item.Category }}</td>
                                    <td>{{ item.AssetProvider }}</td>
                                    <td>{{ item.AssetClassification }}</td>
                                    <td>₹{{ item.total_cost|floatformat:2 }}</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4">No data available.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
           
               
 
            <div class="section" id="idleDaysSection">
                <div class="section-header">
                    <h2 class="section-title">
                        <span>Asset Idle Analysis</span>
                    </h2>
                    <div class="section-controls">
                        <!-- Category Filter Dropdown -->
                        <select id="category-filter" class="form-control" style="width: 200px; margin-right: 1rem;">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                       
                        <button class="btn btn-primary" onclick="downloadIdleReport()">
                            Download Report
                        </button>
                        <button class="btn btn-secondary" onclick="toggleSection('idleDaysSection')">
                            Toggle View
                        </button>
                    </div>
                </div>
                <div class="section-content" id="idleDaysContent">
                    <div class="idle-analysis-container">
                        <!-- Add a flex container for chart and table -->
                        <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                            <!-- Chart container -->
                            <div class="chart-container" style="flex: 2; min-width: 300px;">
                                <canvas id="idleDaysChart"></canvas>
                            </div>
                           
                            <!-- Table container -->
                            <div style="flex: 1; min-width: 300px; max-height: 50vh; overflow-y: auto;">
                                <table class="asset-table" id="assetTable" >
                                    <thead>
                                        <tr>
                                            <th>Asset Name</th>
                                            <th>Cost (₹)</th>
                                            <th>Idle Days</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for asset in assets %}
                                        <tr>
                                            <td>{{ asset.AssetName }}</td>
                                            <td>{{ asset.Cost|floatformat:2 }}</td>
                                            <td>{{ asset.idle_days }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="3">No idle assets available.</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
 
 
 
 
 
        </div>
    </div>
 
    <script>

        document.addEventListener("DOMContentLoaded", function() {
            // Ensure the modal is hidden when the page loads
            document.getElementById("logoutModal").style.display = "none";
        });

        // Open modal when avatar or username is clicked
        function openLogoutModal() {
            document.getElementById("logoutModal").style.display = "flex"; // Show modal
        }

        // Close modal when user clicks outside the modal content
        function closeLogoutModal() {
            document.getElementById("logoutModal").style.display = "none"; // Hide modal
        }

        // Close logout modal if user clicks outside the modal box
        window.onclick = function(event) {
            let logoutModal = document.getElementById("logoutModal");
            // Check if the click happened outside of the modal content (to close it)
            if (event.target === logoutModal) {
                logoutModal.style.display = "none"; // Close modal
            }
        }
        // Toggle section visibility
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const content = section.querySelector('.section-content');
            content.classList.toggle('hidden');
        }
 
        // Download reports functions
        function downloadAssetReport() {
            // Implement PDF generation for asset data
            alert('Downloading asset report...');
        }
 
        function downloadChartsReport() {
            // Implement PDF generation for charts
            alert('Downloading charts report...');
        }
 
        document.addEventListener("DOMContentLoaded", function () {
            const categoryFilter = document.getElementById("category-filter");
            const idleDaysChartCtx = document.getElementById("idleDaysChart").getContext("2d");
            const assetTableBody = document.getElementById("assetTable").getElementsByTagName("tbody")[0];
 
            let idleDaysChart;
 
            // Function to fetch assets based on category
            async function fetchAssets(category = "") {
                const url = `/get_filtered_assets/?category=${encodeURIComponent(category)}`;
                const response = await fetch(url);
                const assets = await response.json();
                return assets;
            }
 
            // Function to render the chart
            function renderChart(assets) {
                const labels = assets.map(asset => asset.AssetName);
                const idleDaysData = assets.map(asset => asset.idle_days);
 
                if (idleDaysChart) {
                    idleDaysChart.destroy(); // Destroy existing chart instance
                }
 
                idleDaysChart = new Chart(idleDaysChartCtx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [{
                            label: "Idle Days",
                            data: idleDaysData,
                            backgroundColor: "#1e40af", // Main color with transparency
                            borderColor: "#1e40af", // Main color without transparency
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: true,
                            },
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
 
            // Function to render the table
            function renderTable(assets) {
                assetTableBody.innerHTML = ""; // Clear existing rows
 
                if (assets.length === 0) {
                    const row = document.createElement("tr");
                    const cell = document.createElement("td");
                    cell.setAttribute("colspan", "3");
                    cell.textContent = "No idle assets available.";
                    row.appendChild(cell);
                    assetTableBody.appendChild(row);
                    return;
                }
 
                assets.forEach(asset => {
                    const row = document.createElement("tr");
 
                    const nameCell = document.createElement("td");
                    nameCell.textContent = asset.AssetName;
                    row.appendChild(nameCell);
 
                    const costCell = document.createElement("td");
                    costCell.textContent = `₹${asset.Cost.toFixed(2)}`;
                    row.appendChild(costCell);
 
                    const idleDaysCell = document.createElement("td");
                    idleDaysCell.textContent = asset.idle_days;
                    row.appendChild(idleDaysCell);
 
                    assetTableBody.appendChild(row);
                });
            }
 
            // Function to handle category filter change
            async function handleCategoryChange() {
                const selectedCategory = categoryFilter.value;
                const assets = await fetchAssets(selectedCategory);
                renderChart(assets);
                renderTable(assets);
            }
 
            // Initialize chart and table with all assets
            async function initialize() {
                const assets = await fetchAssets();
                renderChart(assets);
                renderTable(assets);
            }
 
            // Event listener for category filter
            categoryFilter.addEventListener("change", handleCategoryChange);
 
            // Initialize on page load
            initialize();
        });
 
        function downloadIdleReport() {
            // Get the selected category
            const categoryFilter = document.getElementById("category-filter");
            const selectedCategory = categoryFilter.value;
           
            // Create the URL with the category parameter
            let downloadUrl = '/download_idle_report/';
            if (selectedCategory) {
                downloadUrl += `?category=${encodeURIComponent(selectedCategory)}`;
            }
           
            // Redirect to the download URL
            window.location.href = downloadUrl;
        }
 
        // Make sure to add this event listener after the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const downloadButton = document.querySelector('#idleDaysSection .btn-primary');
            if (downloadButton) {
                downloadButton.addEventListener('click', downloadIdleReport);
            }
        });
 
 
        
   
 
 
    document.addEventListener("DOMContentLoaded", function() {
        // Initialize charts
        const providerChartCtx = document.getElementById('providerChart').getContext('2d');
        const classificationChartCtx = document.getElementById('classificationChart').getContext('2d');
       
        let providerChart;
        let classificationChart;
 
        // Function to fetch cost data based on category
        async function fetchCostData(category = "") {
            const url = `/get_cost_data/?category=${encodeURIComponent(category)}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching cost data:', error);
                return null;
            }
        }
 
        function renderProviderChart(data) {
            if (providerChart) {
                providerChart.destroy();
            }
            providerChart = new Chart(providerChartCtx, {
            type: 'bar',
            data: {
                labels: ['CSI-Borrowed', 'CSI-Purchased', 'BGSW'],
                datasets: [{
                    label: 'Cost (₹)',
                    data: [data.csi_borrowed_cost, data.csi_purchased_cost, data.bgsw_cost],
                    backgroundColor: ['#1e40af', '#4f46e5', '#1e40af'],
                    borderColor: ['#1e3a8a', '#4338ca', '#2563eb'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return '₹' + context.raw.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
 
            // Update summary boxes
            document.getElementById('total-cost').textContent = data.total_cost.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('csi-purchased-cost').textContent = data.csi_purchased_cost.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('csi-borrowed-cost').textContent = data.csi_borrowed_cost.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('total-csi-cost').textContent = data.total_csi_cost.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('bgsw-cost').textContent = data.bgsw_cost.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
 
        function renderClassificationChart(data) {
            if (classificationChart) {
                classificationChart.destroy();
            }
            classificationChart = new Chart(classificationChartCtx, {
                type: 'bar',
                data: {
                    labels: ['Consumables', 'Non Consumables'],
                    datasets: [{
                        label: 'Cost (₹)',
                        data: [data.consumables_cost, data.non_consumables_cost],
                        backgroundColor: ['#1e40af', '#1e40af'],
                        borderColor: ['#1e3a8a', '#2563eb'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, // Ensures the chart resizes with its container
                    maintainAspectRatio: false, // Prevents unnecessary stretching
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₹' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '₹' + context.raw.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            document.getElementById('consumables-cost').textContent = data.consumables_cost.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            // Update Non Consumables cost
            document.getElementById('non-consumables-cost').textContent = data.non_consumables_cost.toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
 
        // Function to update all visualizations
        async function updateVisualizations(category = "") {
            const data = await fetchCostData(category);
            if (data) {
                renderProviderChart(data);
                renderClassificationChart(data);
            }
        }
 
        // Event listener for category filter
        const categoryFilter = document.getElementById('cost-category-filter');
        if (categoryFilter) {
            categoryFilter.addEventListener('change', function() {
                updateVisualizations(this.value);
            });
        }
 
        // Initial load
        updateVisualizations();
    });
    function downloadCostAnalysisReport() {
        const category = document.getElementById('cost-category-filter').value;
        const url = `/download-cost-analysis/?category=${encodeURIComponent(category)}`;
        window.location.href = url;
    }
           
    function downloadCombinedReports() {
        const categoryFilter = document.getElementById('cost-category-filter');
        const selectedCategory = categoryFilter ? categoryFilter.value : '';
        
        let downloadUrl = '/download-combined-reports/';
        if (selectedCategory) {
            downloadUrl += `?category=${encodeURIComponent(selectedCategory)}`;
        }
        
        window.location.href = downloadUrl;
    }
       
    </script>
</body>
</html>